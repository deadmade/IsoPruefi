<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IsoPruefi Arduino: include/core.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">IsoPruefi Arduino
   </div>
   <div id="projectbrief">Arduino firmware for IsoPruefi temperature monitoring system</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_d44c64559bbebec7f509842c48db8b23.html">include</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">core.h File Reference</div></div>
</div><!--header-->
<div class="contents">

<p><a href="core_8h_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ab2663357b0b9fda0a3b6f6c4456daa12" id="r_ab2663357b0b9fda0a3b6f6c4456daa12"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="core_8h.html#ab2663357b0b9fda0a3b6f6c4456daa12">CoreSetup</a> ()</td></tr>
<tr class="memdesc:ab2663357b0b9fda0a3b6f6c4456daa12"><td class="mdescLeft">&#160;</td><td class="mdescRight">Initializes all core system components and peripherals.  <br /></td></tr>
<tr class="separator:ab2663357b0b9fda0a3b6f6c4456daa12"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:add0006ee50cb0bc41312da546591a02a" id="r_add0006ee50cb0bc41312da546591a02a"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="core_8h.html#add0006ee50cb0bc41312da546591a02a">CoreLoop</a> ()</td></tr>
<tr class="memdesc:add0006ee50cb0bc41312da546591a02a"><td class="mdescLeft">&#160;</td><td class="mdescRight">Main operational loop for continuous sensor monitoring, MQTT transmission, and robust data recovery.  <br /></td></tr>
<tr class="separator:add0006ee50cb0bc41312da546591a02a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ad2926b332df58811bd7c1903d4f43201" id="r_ad2926b332df58811bd7c1903d4f43201"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="core_8h.html#ad2926b332df58811bd7c1903d4f43201">IsWifiConnected</a> ()</td></tr>
<tr class="separator:ad2926b332df58811bd7c1903d4f43201"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a48f7d21be0a2e633ba6377e12e8dd8b9" id="r_a48f7d21be0a2e633ba6377e12e8dd8b9"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="core_8h.html#a48f7d21be0a2e633ba6377e12e8dd8b9">IsMqttConnected</a> ()</td></tr>
<tr class="separator:a48f7d21be0a2e633ba6377e12e8dd8b9"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a3497f9bddce44ba60bc1629f84d93de5" id="r_a3497f9bddce44ba60bc1629f84d93de5"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="core_8h.html#a3497f9bddce44ba60bc1629f84d93de5">FatDateTime</a> (uint16_t *date, uint16_t *time)</td></tr>
<tr class="memdesc:a3497f9bddce44ba60bc1629f84d93de5"><td class="mdescLeft">&#160;</td><td class="mdescRight">Callback function for FAT file system timestamp generation.  <br /></td></tr>
<tr class="separator:a3497f9bddce44ba60bc1629f84d93de5"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="add0006ee50cb0bc41312da546591a02a" name="add0006ee50cb0bc41312da546591a02a"></a>
<h2 class="memtitle"><span class="permalink"><a href="#add0006ee50cb0bc41312da546591a02a">&#9670;&#160;</a></span>CoreLoop()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CoreLoop </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Main operational loop for continuous sensor monitoring, MQTT transmission, and robust data recovery. </p>
<p>This function implements the primary logic for the temperature monitoring system, including:</p><ul>
<li>Real-time sensor measurement and transmission via MQTT with QoS 1</li>
<li>Intelligent WiFi and MQTT connection management with automatic reconnection</li>
<li>Fallback to CSV batch storage during connectivity outages</li>
<li>Recovery and transmission of offline data after successful reconnection</li>
<li>Comprehensive error handling and status reporting</li>
</ul>
<p>**Operational Flow:** 1. Time Management: Reads current time from RTC, tracks minute changes to avoid duplicate measurements. 2. WiFi Connection: Monitors status, attempts reconnection, falls back to CSV logging if offline. 3. MQTT Connection: Verifies broker connectivity, reconnects as needed, falls back to CSV logging if offline. 4. Data Recovery: Sends pending CSV data after reconnection, ensures recovery only once per cycle. 5. Normal Operation: Measures temperature, transmits via MQTT, polls for incoming messages.</p>
<p>**Error Handling:**</p><ul>
<li>Network or broker failures trigger CSV fallback storage for all measurements.</li>
<li>Connection attempts are rate-limited to prevent resource exhaustion.</li>
<li>All measurement data is preserved and recovered after connectivity is restored.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Maintains a fixed loop delay for consistent timing and system stability. </dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="core_8cpp.html#a6cef1bc6ccf08999da59db3b88095f7d">RECONNECT_INTERVAL_MS</a>, <a class="el" href="core_8cpp.html#aa9b3766a24a11a11d57c6ba9114d992b">LOOP_DELAY_MS</a> for timing configuration </dd>
<dd>
saveToCsvBatch() for offline data storage </dd>
<dd>
sendPendingData() for data recovery and MQTT retransmission </dd></dl>

</div>
</div>
<a id="ab2663357b0b9fda0a3b6f6c4456daa12" name="ab2663357b0b9fda0a3b6f6c4456daa12"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab2663357b0b9fda0a3b6f6c4456daa12">&#9670;&#160;</a></span>CoreSetup()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void CoreSetup </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Initializes all core system components and peripherals. </p>
<p>This function performs comprehensive system initialization including:</p>
<p>**Network Setup:**</p><ul>
<li>Establishes WiFi connection with timeout handling</li>
<li>Configures MQTT client with unique sensor-based ID</li>
<li>Attempts initial MQTT broker connection</li>
</ul>
<p>**Hardware Initialization:**</p><ul>
<li>Initializes DS3231 real-time clock module</li>
<li>Adjusts RTC time if power was lost (uses compilation timestamp)</li>
<li>Sets up SD card with SPI communication</li>
<li>Initializes ADT7410 temperature sensor</li>
</ul>
<p>**Data Recovery:**</p><ul>
<li>Registers FAT file system timestamp callback</li>
</ul>
<dl class="section warning"><dt>Warning</dt><dd>This function will halt program execution (infinite loop) if any critical component fails to initialize (RTC, SD card, or temperature sensor)</dd></dl>
<dl class="section note"><dt>Note</dt><dd>The function uses compile-time constants for timeouts and configuration </dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="core_8cpp.html#a9b7578cbf8a2ac9a8a2ccb3fc5431791">WIFI_CONNECT_TIMEOUT_MS</a>, <a class="el" href="core_8cpp.html#a4ae62406649dce01eb479e7a476a4305">CLIENT_ID_BUFFER_SIZE</a>, <a class="el" href="core_8cpp.html#a4f1edbd0b6c65e5e7843bbda20bb24e2">SD_SCK_FREQUENCY_MHZ</a> </dd></dl>

</div>
</div>
<a id="a3497f9bddce44ba60bc1629f84d93de5" name="a3497f9bddce44ba60bc1629f84d93de5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3497f9bddce44ba60bc1629f84d93de5">&#9670;&#160;</a></span>FatDateTime()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void FatDateTime </td>
          <td>(</td>
          <td class="paramtype">uint16_t *&#160;</td>
          <td class="paramname"><em>date</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint16_t *&#160;</td>
          <td class="paramname"><em>time</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Callback function for FAT file system timestamp generation. </p>
<p>This function is used by the SdFat library to obtain current date and time for file system operations. It retrieves the time from the RTC and converts it to the FAT file system format using the appropriate macros.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[out]</td><td class="paramname">date</td><td>Pointer to store the encoded FAT date (year, month, day) </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">time</td><td>Pointer to store the encoded FAT time (hour, minute, second)</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This function is registered as a callback with SdFile::dateTimeCallback() </dd></dl>
<dl class="section see"><dt>See also</dt><dd>FAT_DATE, FAT_TIME macros for encoding format details </dd></dl>

</div>
</div>
<a id="a48f7d21be0a2e633ba6377e12e8dd8b9" name="a48f7d21be0a2e633ba6377e12e8dd8b9"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a48f7d21be0a2e633ba6377e12e8dd8b9">&#9670;&#160;</a></span>IsMqttConnected()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool IsMqttConnected </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
<a id="ad2926b332df58811bd7c1903d4f43201" name="ad2926b332df58811bd7c1903d4f43201"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad2926b332df58811bd7c1903d4f43201">&#9670;&#160;</a></span>IsWifiConnected()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">bool IsWifiConnected </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
