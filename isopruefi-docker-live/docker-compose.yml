networks:
  isopruefi-network:
    driver: bridge
  isopruefi-monitoring:

services:
  traefik:
    image: traefik:3.4.4
    container_name: isopruefi-loadbalancer
    restart: unless-stopped
    ports:
      - 5000:80
      - 5001:443
      - 5002:8080
    labels:
      - "traefik.enable=true"

      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.rule=Host(`traefik.aicon.dhbw-heidenheim.de`)"
      - "traefik.http.services.dashboard.loadbalancer.server.port=5002"

      - "traefik.http.routers.dashboard.tls.domains[0].main=aicon.dhbw-heidenheim.de"
      - "traefik.http.routers.dashboard.tls.domains[0].sans=aicon.dhbw-heidenheim.de"

      - "traefik.http.middlewares.traefik-https-redirect.redirectscheme.scheme = https"
      - "traefik.http.middlewares.sslheader.headers.customrequestheaders.X-Forwarded-Proto = https"

      - "logging.isopruefi.enabled=true"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik/traefik.yml:/traefik.yml:ro"
      - "./traefik/conf:/conf:ro"
      - "./traefik/certs/:/var/traefik/certs/:rw"
    networks:
      - isopruefi-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  influxdb3:
    image: influxdb:3.2.1-core
    container_name: isopruefi-influxdb
    restart: unless-stopped
    labels:
      - logging.isopruefi.enabled=true
    command:
      - influxdb3
      - serve
      - --node-id=node0
      - --object-store=file
      - --data-dir=/var/lib/influxdb3
    volumes:
      - influxdb3:/var/lib/influxdb3
    networks:
      - isopruefi-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:17.5
    container_name: isopruefi-postgres
    restart: unless-stopped
    ports:
      - 5003:5432
    labels:
      - "logging.isopruefi.enabled=true"
    volumes:
      - postgres:/var/lib/postgresql/data
    networks:
      - isopruefi-network
    env_file:
      - ./secrets.env
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  loki:
    image: grafana/loki:3.5.2
    container_name: isopruefi-loki
    command: -config.file=/etc/loki/local-config.yaml
    labels:
      - "logging.isopruefi.enabled=true"
    volumes:
      - ./loki/loki-config.yaml:/etc/loki/local-config.yaml
      - loki:/loki
    networks:
      - isopruefi-monitoring
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  prometheus:
    image: prom/prometheus:v3.4.2
    container_name: isopruefi-prometheus
    labels:
      - "logging.isopruefi.enabled=true"
      - "web.enable-remote-write-receiver"
    ports:
      - 5004:9090
    command:
      - --config.file=/etc/prometheus/prometheus.yml
    volumes:
      - ./loki/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./loki/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus:/prometheus
    networks:
      - isopruefi-monitoring
      - isopruefi-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  alloy:
    image: grafana/alloy:v1.9.2
    container_name: isopruefi-alloy
    labels:
      - "logging.isopruefi.enabled=true"
    volumes:
      - ./loki/config.alloy:/etc/alloy/config.alloy
      - /var/run/docker.sock:/var/run/docker.sock
    command: run --server.http.listen-addr=0.0.0.0:12345 --storage.path=/var/lib/alloy/data /etc/alloy/config.alloy
    networks:
      - isopruefi-monitoring
    depends_on:
      - loki
      - prometheus
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:12345/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  grafana:
    image: grafana/grafana:12.0.2
    container_name: isopruefi-grafana
    labels:
      - logging.isopruefi.enabled=true
    ports:
      - 5005:3000
    volumes:
      - "./grafana/grafana.ini:/etc/grafana/grafana.ini:ro"
    env_file:
      - ./secrets.env
    networks:
      - isopruefi-monitoring
    depends_on:
      - loki
      - alloy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    entrypoint:
      - sh
      - -euc
      - |
        mkdir -p /etc/grafana/provisioning/datasources
        cat <<EOF > /etc/grafana/provisioning/datasources/ds.yaml
        apiVersion: 1
        datasources:
        - name: Loki
          type: loki
          access: proxy
          orgId: 1
          url: http://loki:3100
          basicAuth: false
          isDefault: false
          version: 1
          editable: false
        - name: Prometheus
          type: prometheus
          orgId: 1
          url: http://prometheus:9090
          basicAuth: false
          isDefault: true
          version: 1
          editable: false
        EOF
        /run.sh

  isopruefi-frontend-1:
    image: ghcr.io/deadmade/isopruefi-frontend:latest
    container_name: isopruefi-frontend-1
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/frontend`)"
      - "traefik.http.middlewares.frontend-stripprefix.stripprefix.prefixes=/frontend"
      - "traefik.http.routers.frontend.middlewares=frontend-stripprefix"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "logging.isopruefi.enabled=true"
    volumes:
      - ./isopruefi-frontend:/app
      - /app/node_modules
    networks:
      - isopruefi-network
    environment:
      - NODE_ENV=development
    stdin_open: true
    tty: true

  isopruefi-frontend-2:
    image: ghcr.io/deadmade/isopruefi-frontend:latest
    container_name: isopruefi-frontend-2
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=PathPrefix(`/frontend`)"
      - "traefik.http.middlewares.frontend-stripprefix.stripprefix.prefixes=/frontend"
      - "traefik.http.routers.frontend.middlewares=frontend-stripprefix"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "logging.isopruefi.enabled=true"
    volumes:
      - ./isopruefi-frontend:/app
      - /app/node_modules
    networks:
      - isopruefi-network
    environment:
      - NODE_ENV=development
    stdin_open: true
    tty: true

  isopruefi-backend-api-1:
    image: ghcr.io/deadmade/isopruefi-rest-api:latest
    container_name: isopruefi-backend-api-1
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=PathPrefix(`/backend`)"
      - "traefik.http.middlewares.backend-stripprefix.stripprefix.prefixes=/backend"
      - "traefik.http.routers.backend.middlewares=backend-stripprefix"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls=true"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"
      - "logging.isopruefi.enabled=true"
    networks:
      - isopruefi-network
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
    env_file:
      - ./secrets.env
    depends_on:
      - influxdb3
      - postgres
      - loki

  isopruefi-backend-api-2:
    image: ghcr.io/deadmade/isopruefi-rest-api:latest
    container_name: isopruefi-backend-api-2
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=PathPrefix(`/backend`)"
      - "traefik.http.middlewares.backend-stripprefix.stripprefix.prefixes=/backend"
      - "traefik.http.routers.backend.middlewares=backend-stripprefix"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls=true"
      - "traefik.http.services.backend.loadbalancer.server.port=8080"
      - "logging.isopruefi.enabled=true"
    networks:
      - isopruefi-network
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
    env_file:
      - ./secrets.env
    depends_on:
      - influxdb3
      - postgres
      - loki

  isopruefi-mqtt-receiver-1:
    image: ghcr.io/deadmade/isopruefi-mqtt-worker:latest
    container_name: isopruefi-mqtt-receiver-1
    labels:
      - "logging.isopruefi.enabled=true"
    networks:
      - isopruefi-network
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
    env_file:
      - ./secrets.env
    depends_on:
      - influxdb3
      - postgres
      - loki

  isopruefi-mqtt-receiver-2:
    image: ghcr.io/deadmade/isopruefi-mqtt-worker:latest
    container_name: isopruefi-mqtt-receiver-2
    labels:
      - "logging.isopruefi.enabled=true"
    networks:
      - isopruefi-network
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
    env_file:
      - ./secrets.env
    depends_on:
      - influxdb3
      - postgres
      - loki

  isopruefi-get-weather-worker-1:
    image: ghcr.io/deadmade/isopruefi-weather-worker:latest
    container_name: isopruefi-get-weather-worker-1
    labels:
      - "logging.isopruefi.enabled=true"
    networks:
      - isopruefi-network
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
    env_file:
      - ./secrets.env
    depends_on:
      - influxdb3
      - postgres
      - loki


  isopruefi-get-weather-worker-2:
    image: ghcr.io/deadmade/isopruefi-weather-worker:latest
    container_name: isopruefi-get-weather-worker-2
    labels:
      - "logging.isopruefi.enabled=true"
    networks:
      - isopruefi-network
    environment:
      - ASPNETCORE_ENVIRONMENT=Docker
    env_file:
      - ./secrets.env
    depends_on:
      - influxdb3
      - postgres
      - loki


volumes:
  influxdb3:
  postgres:
  loki:
  prometheus:
